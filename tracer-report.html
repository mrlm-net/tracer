<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>Tracer Report</title>
		<!-- Tailwind CDN -->
		<script>
			// Follow Tailwind docs: set initial dark class with system-theme support
			(function(){
				try{
					document.documentElement.classList.toggle('dark', localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches))
				}catch(e){/* ignore */}
			})()
		</script>

		<script>
			// Use class-based dark mode so toggling the `dark` class works
			window.tailwind = window.tailwind || {}
			tailwind.config = tailwind.config || {}
			tailwind.config.darkMode = 'class'
		</script>
		<script src="https://cdn.tailwindcss.com"></script>
	</head>
	<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-white">
		<div class="max-w-6xl mx-auto p-6">
						<div class="border-b border-gray-200 pb-5 dark:border-white/10">
						  <div class="sm:flex sm:items-baseline sm:justify-between">
						    <div class="sm:w-0 sm:flex-1">
						      <h1 id="message-heading" class="text-base font-semibold text-gray-900 dark:text-white">Tracer Report</h1>
						      <p class="mt-1 truncate text-sm text-gray-500 dark:text-gray-400">Network tracer results</p>
						      <div id="report-meta" class="mt-2 text-sm text-gray-600 dark:text-gray-400"></div>
						    </div>

                
						  </div>
						</div>

					<div id="summary" class="pt-2 mb-6"></div>

			<!-- events list (uses Tailwind list layout) -->
			<ul id="events" role="list" class="divide-y divide-gray-100 dark:divide-white/5">
				<!-- items injected by script -->
			</ul>
		</div>

		<!-- JSON data placeholder -->
		<script id="__DATA__" type="application/json">[{"timestamp":"2025-12-30T21:10:50.16661Z","protocol":"http","event_type":"lifecycle","stage":"request_start","trace_id":"dc62f2fb-a46b-4bdd-b9e6-e0c35e1a7d98","payload":{"url":"https://example.com/"}},{"timestamp":"2025-12-30T21:10:50.167345Z","protocol":"http","event_type":"lifecycle","stage":"request_send","trace_id":"dc62f2fb-a46b-4bdd-b9e6-e0c35e1a7d98","payload":{"headers":{},"method":"GET","url":"https://example.com/"}},{"timestamp":"2025-12-30T21:10:50.168493Z","protocol":"http","event_type":"lifecycle","stage":"dns_start","trace_id":"dc62f2fb-a46b-4bdd-b9e6-e0c35e1a7d98","duration_ns":1857517,"payload":{"host":"example.com"}},{"timestamp":"2025-12-30T21:10:50.17143Z","protocol":"http","event_type":"lifecycle","stage":"dns_done","trace_id":"dc62f2fb-a46b-4bdd-b9e6-e0c35e1a7d98","duration_ns":2937250,"payload":{"addrs":[{"IP":"2606:4700::6812:1a78","Zone":""},{"IP":"2606:4700::6812:1b78","Zone":""},{"IP":"104.18.26.120","Zone":""},{"IP":"104.18.27.120","Zone":""}]}},{"timestamp":"2025-12-30T21:10:50.171689Z","protocol":"http","event_type":"lifecycle","stage":"connect_start","trace_id":"dc62f2fb-a46b-4bdd-b9e6-e0c35e1a7d98","duration_ns":5054123,"payload":{"addr":"[2606:4700::6812:1a78]:443","network":"tcp6"}},{"timestamp":"2025-12-30T21:10:50.249243Z","protocol":"http","event_type":"lifecycle","stage":"connect_done","trace_id":"dc62f2fb-a46b-4bdd-b9e6-e0c35e1a7d98","duration_ns":77552312,"payload":{"addr":"[2606:4700::6812:1a78]:443","error":"","network":"tcp6"}},{"timestamp":"2025-12-30T21:10:50.249261Z","protocol":"http","event_type":"lifecycle","stage":"tls_handshake_start","trace_id":"dc62f2fb-a46b-4bdd-b9e6-e0c35e1a7d98","duration_ns":82624866},{"timestamp":"2025-12-30T21:10:50.278107Z","protocol":"http","event_type":"lifecycle","stage":"tls_handshake_done","trace_id":"dc62f2fb-a46b-4bdd-b9e6-e0c35e1a7d98","duration_ns":28844348,"payload":{"cipher_suite":4865,"err":"","negotiated_proto":"h2"}},{"timestamp":"2025-12-30T21:10:50.278868Z","protocol":"http","event_type":"lifecycle","stage":"got_conn","trace_id":"dc62f2fb-a46b-4bdd-b9e6-e0c35e1a7d98","duration_ns":112230723,"payload":{"reused":false,"was_idle":false}},{"timestamp":"2025-12-30T21:10:50.279158Z","protocol":"http","event_type":"lifecycle","stage":"wrote_request","trace_id":"dc62f2fb-a46b-4bdd-b9e6-e0c35e1a7d98","duration_ns":112521271,"payload":{"error":""}},{"timestamp":"2025-12-30T21:10:50.321048Z","protocol":"http","event_type":"lifecycle","stage":"got_first_response_byte","trace_id":"dc62f2fb-a46b-4bdd-b9e6-e0c35e1a7d98","duration_ns":154410998},{"timestamp":"2025-12-30T21:10:50.32127Z","protocol":"http","event_type":"lifecycle","stage":"response_headers","trace_id":"dc62f2fb-a46b-4bdd-b9e6-e0c35e1a7d98","payload":{"headers":{"Age":["7140"],"Allow":["GET, HEAD"],"Cf-Cache-Status":["HIT"],"Cf-Ray":["9b6486b4b940f982-PRG"],"Content-Type":["text/html"],"Date":["Tue, 30 Dec 2025 21:10:50 GMT"],"Last-Modified":["Sat, 20 Dec 2025 05:42:21 GMT"],"Server":["cloudflare"],"Vary":["Accept-Encoding"]},"status":"200 OK"}},{"timestamp":"2025-12-30T21:10:50.321635Z","protocol":"http","event_type":"lifecycle","stage":"response_end","trace_id":"dc62f2fb-a46b-4bdd-b9e6-e0c35e1a7d98","duration_ns":154997932,"payload":{"bytes_read":513,"status":"200 OK"}}]</script>

		<script>
			(function(){
				// initialize theme from localStorage or prefers-color-scheme
					const THEME_KEY = 'theme'
					function applyTheme(theme){
					const root = document.documentElement
					if(theme === 'dark'){
						root.classList.add('dark')
						document.getElementById('icon-sun').classList.add('hidden')
						document.getElementById('icon-moon').classList.remove('hidden')
						document.getElementById('theme-toggle').setAttribute('aria-pressed','true')
					} else {
						root.classList.remove('dark')
						document.getElementById('icon-sun').classList.remove('hidden')
						document.getElementById('icon-moon').classList.add('hidden')
						document.getElementById('theme-toggle').setAttribute('aria-pressed','false')
					}
				}

				// small helpers
				function el(tag, cls, html){ const n = document.createElement(tag); if(cls) n.className = cls; if(html!==undefined) n.innerHTML = html; return n }

				function statusBadge(e){
					// determine status label and classes
					const et = (e.event_type||'').toLowerCase()
					// Use provided badge styles for different statuses
					if(et === 'error') return {txt:'Error', cls:'inline-flex items-center rounded-md bg-red-100 px-2 py-1 text-xs font-medium text-red-700 dark:bg-red-400/10 dark:text-red-400'}
					if(et === 'metric') return {txt:'Metric', cls:'inline-flex items-center rounded-md bg-gray-100 px-2 py-1 text-xs font-medium text-gray-600 dark:bg-gray-400/10 dark:text-gray-400'}
					// consider stage-based complete
					if(e.stage && /done|complete|response|closed/i.test(e.stage)) return {txt:'Complete', cls:'inline-flex items-center rounded-md bg-green-100 px-2 py-1 text-xs font-medium text-green-700 dark:bg-green-400/10 dark:text-green-400'}
					// default: in-progress
					return {txt:'In progress', cls:'inline-flex items-center rounded-md bg-yellow-100 px-2 py-1 text-xs font-medium text-yellow-800 dark:bg-yellow-400/10 dark:text-yellow-500'}
				}

				try{
					const raw = document.getElementById('__DATA__')?.textContent || '[]'
					const events = JSON.parse(raw)
					const summary = document.getElementById('summary')
					const list = document.getElementById('events')
					const byProto = events.reduce((acc,e)=>{ acc[e.protocol||( 'unknown' )] = (acc[e.protocol||'unknown']||0)+1; return acc }, {});
					const protoParts = Object.keys(byProto).map(p=>`<span class="mr-3">${p}: <strong>${byProto[p]}</strong></span>`).join('');
					summary.innerHTML = `<div class="text-sm text-gray-600 dark:text-gray-400">Events: ${events.length} &nbsp; ${protoParts}</div>`;

											// lightweight metadata population: scan events for target/host/ip/protocol/port/status
											(function(){
												const meta = document.getElementById('report-meta')
												if(!meta) return
												let target='', host='', ip='', port='', proto='', status=''

												for(const ev of events){
													const p = ev.payload || {}
													if(!target && (p.url || p.target || p.host)) target = p.url || p.target || p.host
													if(!host && (p.host || p.hostname)) host = p.host || p.hostname
													if(!proto && ev.protocol) proto = ev.protocol
													if(!status && (p.status || p.code)) status = p.status || p.code

													// collect IP from addrs array (dns_done) or addr fields
													if(!ip){
														if(Array.isArray(p.addrs) && p.addrs.length){
															const a = p.addrs.find(x=>x.IP && x.IP.indexOf('.')!==-1) || p.addrs[0]
															if(a && a.IP) ip = a.IP
														}
														if(!ip && p.addr){
															// addr formats: 104.18.26.120:443 or [2606:...]:443
															const m = p.addr.match(/\[?([^\]]+)\]?:([0-9]+)/)
															if(m){ ip = m[1]; if(!port) port = m[2] }
														}
														if(!ip && p.ip) ip = p.ip
													}

													if(!port){
														if(p.port) port = p.port
														if(p._port) port = p._port
														if(!port && p.addr){
															const m2 = p.addr.match(/:([0-9]+)\]?$/)
															if(m2) port = m2[1]
														}
													}

													if(target && host && ip && port && proto) break
												}

												const parts = []
												if(target) parts.push(`Target: <strong>${target}</strong>`)
												if(host) parts.push(`Host: <strong>${host}</strong>`)
												if(ip) parts.push(`IP: <strong>${ip}</strong>`)
												if(port) parts.push(`Port: <strong>${port}</strong>`)
												if(proto) parts.push(`Proto: <strong>${proto}</strong>`)
												if(status) parts.push(`Status: <strong>${status}</strong>`)
												meta.innerHTML = parts.join(' &nbsp; â€¢ &nbsp; ')

											})()



					if(events.length === 0){
						list.innerHTML = '<li class="py-5 text-sm text-gray-500">No events collected.</li>'
						return
					}

					events.forEach((e, idx)=>{
						const li = el('li','flex items-center justify-between gap-x-6 py-5')
						const left = el('div','min-w-0')
						const titleRow = el('div','flex items-start gap-x-3')
						let titleText = ''
						if(e.payload && (e.payload.title || e.payload.name)){
							titleText = e.payload.title || e.payload.name
						} else if(e.protocol && e.stage){
							titleText = `${(e.protocol||'').toUpperCase()} ${e.stage||''}`
						} else if(e.payload && (e.payload.url || e.payload.target || e.payload.host)){
							titleText = e.payload.url || e.payload.target || e.payload.host
						} else {
							titleText = `${(e.protocol||'').toUpperCase()} ${e.stage||''}`
						}
						titleText = (titleText||'').toString()
						titleRow.appendChild(el('p','text-sm font-semibold text-gray-900 dark:text-white', titleText))
						const badge = statusBadge(e)
						titleRow.appendChild(el('p', badge.cls, badge.txt))
						left.appendChild(titleRow)

						const metaRow = el('div','mt-1 flex items-center gap-x-2 text-xs text-gray-500')
						const ts = e.timestamp || ''
						let timeDisplay = ''
						if(ts){
							const parsed = Date.parse(ts)
							timeDisplay = isNaN(parsed) ? ts : new Date(parsed).toLocaleString(undefined, {timeZone: 'UTC'})
						}
						const timeHtml = `<p class="whitespace-nowrap">${timeDisplay}</p>`
						metaRow.innerHTML = timeHtml + `<svg viewBox="0 0 2 2" class="size-0.5 fill-current mx-1"><circle r="1" cx="1" cy="1"/></svg>` + `<p class="truncate">${e.trace_id || ''}</p>`
						left.appendChild(metaRow)

						li.appendChild(left)

						const right = el('div','flex flex-none items-center gap-x-4')
						// small static time-since-start label (visible on all sizes)
						const startTs = events[0] && events[0].timestamp ? Date.parse(events[0].timestamp) : NaN
						const thisTs = e.timestamp ? Date.parse(e.timestamp) : NaN
						const deltaMs = (isNaN(startTs) || isNaN(thisTs)) ? '-' : (thisTs - startTs)
						const viewLink = el('div','rounded-md bg-white dark:bg-white/10 px-2 py-0.5 text-xs font-semibold text-gray-900 dark:text-white shadow-xs flex items-center justify-center', (deltaMs === '-' ? '-' : `${deltaMs} ms`))
						right.appendChild(viewLink)

						// dropdown placeholder
						const dd = el('div','relative flex-none')
						const btn = el('button','relative block text-gray-500 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white cursor-pointer p-1')
						btn.innerHTML = `<span class=\"absolute -inset-2.5\"></span><span class=\"sr-only\">Open options</span><svg viewBox=\"0 0 20 20\" fill=\"currentColor\" class=\"size-5\"><path d=\"M10 3a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM10 8.5a1.5 1.5 0 1 1 0 3 1.5 1.5 0 0 1 0-3ZM11.5 15.5a1.5 1.5 0 1 0-3 0 1.5 1.5 0 0 0 3 0Z\"/></svg>`
						dd.appendChild(btn)
						right.appendChild(dd)

						li.appendChild(right)

						// details panel (hidden, toggle via link)
						const detailsPanel = el('div','col-span-3 mt-2 hidden')
						// include headers list if present (render as definition list using template style)
						if(e.payload && e.payload.headers){
							detailsPanel.appendChild(el('div','text-xs text-gray-600 mb-1','Headers'))
							// wrapper and definition list
							const wrapper = document.createElement('div')
							wrapper.className = 'mt-2 border-t border-gray-100 dark:border-white/10'
							const dl = document.createElement('dl')
							dl.className = 'divide-y divide-gray-100 dark:divide-white/10'

							// render each header as a dt/dd pair following the Applicant Information template
							for(const k of Object.keys(e.payload.headers)){
								const row = document.createElement('div')
								row.className = 'px-4 py-3 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0'

								const dt = document.createElement('dt')
								dt.className = 'text-sm/6 font-medium text-gray-900 dark:text-gray-100'
								dt.textContent = k

								const dd = document.createElement('dd')
								dd.className = 'mt-1 text-sm/6 text-gray-700 sm:col-span-2 sm:mt-0 dark:text-gray-400'
								// ensure header values are rendered as text
								const val = e.payload.headers[k]
								dd.textContent = (val === undefined || val === null) ? '' : String(val)

								row.appendChild(dt)
								row.appendChild(dd)
								dl.appendChild(row)
							}

							wrapper.appendChild(dl)
							detailsPanel.appendChild(wrapper)
						}
						// raw payload / tags
						if(e.tags && Object.keys(e.tags).length>0){
								detailsPanel.appendChild(el('div','text-xs text-gray-600 mb-1','Tags'))
								detailsPanel.appendChild(el('pre','text-xs bg-gray-100 dark:bg-gray-800 dark:text-gray-200 p-2',JSON.stringify(e.tags, null, 2)))
							}
							detailsPanel.appendChild(el('pre','text-xs bg-gray-100 dark:bg-gray-800 dark:text-gray-200 p-2 mt-2',JSON.stringify(e, null, 2)))

						// wire toggle: three-dot button opens/closes the details panel
						btn.addEventListener('click', (ev)=>{
							ev.preventDefault()
							detailsPanel.classList.toggle('hidden')
							const open = !detailsPanel.classList.contains('hidden')
							btn.setAttribute('aria-pressed', String(open))
								if(open){
									btn.classList.remove('text-gray-500','dark:text-gray-300')
									btn.classList.add('text-gray-900','dark:text-white')
								} else {
									btn.classList.remove('text-gray-900','dark:text-white')
									btn.classList.add('text-gray-500','dark:text-gray-300')
								}
						})

						// append to list as a fragment: main li + details as next sibling
						list.appendChild(li)
						const detailsLi = el('li','p-0')
						detailsLi.appendChild(detailsPanel)
						list.appendChild(detailsLi)

				})
                } catch(err){
                    console.error('Error rendering report:', err)
                    const list = document.getElementById('events')
                    list.innerHTML = '<li class="py-5 text-sm text-red-500">Error rendering report.</li>'
                }
			})()
		</script>
	</body>
</html>
